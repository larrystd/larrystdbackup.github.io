<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><link href="/css/tag-common/index.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="larry"><meta name="copyright" content="larry"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>muduoç½‘ç»œåº“ 03 eventloop channel poller | æ‹‰ç‘å›ã®å°çª</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://cdn.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><script>document.addEventListener(
  "pjax:success",
  function() {
    if (window.aplayers) {
      loadMeting();
    }
  },
  !1
);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#6200ee"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"larrystd.github.io","root":"/","title":"æ‹‰ç‘å›ã®å°çª","version":"1.6.3","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"algolia":{"appID":"CJXXAGRCYN","apiKey":"ae1966d2aeab22bf9335679f45d2cd9a","indexName":"my-hexo-blog","hits":{"per_page":8}},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="æ‹‰ç‘å›ã®å°çª" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="channel æŠ½è±¡ä¸€ä¸ªè¿æ¥ï¼Œè¯¥è¿æ¥å³ç›‘å¬ä¸€ä¸ªfd, å¹¶æ³¨å†Œå¥½fdåˆ°æ¥æ—¶çš„è¯»å†™ç­‰å›è°ƒå‡½æ•°, æ›´æ–°fdçš„äº‹ä»¶å‡½æ•° pollerç”¨æ¥ç›‘å¬å¤šä¸ªè¿æ¥, ä¹Ÿå°±æ˜¯ç›‘å¬å¤šä¸ªfdã€‚éœ€è¦æ³¨å†Œç›‘å¬fd, æ³¨å†Œfdçš„äº‹ä»¶, è¿”å›æ´»è·ƒçš„fdç­‰ã€‚ eventloopä¸»loopè°ƒç”¨pollerè¿”å›æ´»è·ƒçš„channel, æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ã€‚æ­¤å¤–ä¸»çº¿ç¨‹å¯ä»¥è®¾ç½®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡è®©è¯¥çº¿ç¨‹æ‰§è¡Œ, ä»¤è¯¥çº¿ç¨‹çš„loopå¤šç›‘å¬ä¸€ä¸ªeventf">
<meta property="og:type" content="article">
<meta property="og:title" content="muduoç½‘ç»œåº“ 03 eventloop channel poller">
<meta property="og:url" content="https://larrystd.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2021-08-28-muduo%E6%BA%90%E7%A0%813/index.html">
<meta property="og:site_name" content="æ‹‰ç‘å›ã®å°çª">
<meta property="og:description" content="channel æŠ½è±¡ä¸€ä¸ªè¿æ¥ï¼Œè¯¥è¿æ¥å³ç›‘å¬ä¸€ä¸ªfd, å¹¶æ³¨å†Œå¥½fdåˆ°æ¥æ—¶çš„è¯»å†™ç­‰å›è°ƒå‡½æ•°, æ›´æ–°fdçš„äº‹ä»¶å‡½æ•° pollerç”¨æ¥ç›‘å¬å¤šä¸ªè¿æ¥, ä¹Ÿå°±æ˜¯ç›‘å¬å¤šä¸ªfdã€‚éœ€è¦æ³¨å†Œç›‘å¬fd, æ³¨å†Œfdçš„äº‹ä»¶, è¿”å›æ´»è·ƒçš„fdç­‰ã€‚ eventloopä¸»loopè°ƒç”¨pollerè¿”å›æ´»è·ƒçš„channel, æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ã€‚æ­¤å¤–ä¸»çº¿ç¨‹å¯ä»¥è®¾ç½®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡è®©è¯¥çº¿ç¨‹æ‰§è¡Œ, ä»¤è¯¥çº¿ç¨‹çš„loopå¤šç›‘å¬ä¸€ä¸ªeventf">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-08-27T16:00:00.000Z">
<meta property="article:modified_time" content="2021-08-27T16:00:00.000Z">
<meta property="article:author" content="larry">
<meta property="article:tag" content="cpp">
<meta property="article:tag" content="muduo">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="larry"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="larry"><span class="site-author-status" title="Looking for you.">ğŸŒ‘</span></a><div class="site-author-name"><a href="/about/">larry</a></div><a class="site-name" href="/about/site.html">æ‹‰ç‘å›ã®å°çª</a><sub class="site-subtitle"></sub><div class="site-desciption">æ¯å¤©éƒ½æ˜¯æ–°çš„ä¸€å¤©å‘¢</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">86</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">42</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/larrystd" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/bu-qu-dou-yin-bu-gai-ming" title="çŸ¥ä¹" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="Venray.Kong@outlook.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#channel-h"><span class="toc-number">1.</span> <span class="toc-text">channel.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eventloop-h"><span class="toc-number">2.</span> <span class="toc-text">eventloop.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#poller"><span class="toc-number">3.</span> <span class="toc-text">poller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eventloopthread"><span class="toc-number">4.</span> <span class="toc-text">eventloopthread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eventloopthreadPool"><span class="toc-number">5.</span> <span class="toc-text">eventloopthreadPool</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://larrystd.github.io/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2021-08-28-muduo%E6%BA%90%E7%A0%813/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="larry"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="æ‹‰ç‘å›ã®å°çª"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">muduoç½‘ç»œåº“ 03 eventloop channel poller<a class="post-edit-link" href="https://github.com/larrystd/larrystd.github.io/tree/hexo/source/_posts/æºç åˆ†æ/2021-08-28-muduoæºç 3.md" target="_blank" title="ç¼–è¾‘" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-08-28 00:00:00" itemprop="dateCreated datePublished" datetime="2021-08-28T00:00:00+08:00">2021-08-28</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="æœ¬æ–‡å­—æ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="æœ¬æ–‡å­—æ•°">4.9k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ—¶é•¿"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="é˜…è¯»æ—¶é•¿">24m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/source-code/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">source code</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/cpp/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">cpp</span></a><a class="tag-item" href="/tags/muduo/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">muduo</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#6200ee;"><ul>
<li>channel æŠ½è±¡ä¸€ä¸ªè¿æ¥ï¼Œè¯¥è¿æ¥å³ç›‘å¬ä¸€ä¸ªfd, å¹¶æ³¨å†Œå¥½fdåˆ°æ¥æ—¶çš„è¯»å†™ç­‰å›è°ƒå‡½æ•°, æ›´æ–°fdçš„äº‹ä»¶å‡½æ•°</li>
<li>pollerç”¨æ¥ç›‘å¬å¤šä¸ªè¿æ¥, ä¹Ÿå°±æ˜¯ç›‘å¬å¤šä¸ªfdã€‚éœ€è¦æ³¨å†Œç›‘å¬fd, æ³¨å†Œfdçš„äº‹ä»¶, è¿”å›æ´»è·ƒçš„fdç­‰ã€‚</li>
<li>eventloopä¸»loopè°ƒç”¨pollerè¿”å›æ´»è·ƒçš„channel, æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ã€‚æ­¤å¤–ä¸»çº¿ç¨‹å¯ä»¥è®¾ç½®ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡è®©è¯¥çº¿ç¨‹æ‰§è¡Œ, ä»¤è¯¥çº¿ç¨‹çš„loopå¤šç›‘å¬ä¸€ä¸ªeventfd, ä¸»çº¿ç¨‹æƒ³è®©è¯¥çº¿ç¨‹æ‰§è¡Œä»»åŠ¡åªéœ€è¦å†™wakefd, è¯¥çº¿ç¨‹å°±ä¼šåœæ­¢epoll_waité˜»å¡ï¼Œå»æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ã€‚wakefd_èµ·åˆ°æ¡ä»¶å˜é‡çš„ä½œç”¨ã€‚</li>
</ul>
<h4 id="channel-h"><a href="#channel-h" class="headerlink" title="channel.h"></a>channel.h</h4><p>channelæ˜¯ä¸€ä¸ªç½‘ç»œè¿æ¥çš„æŠ½è±¡, ä¸»è¦ä½œç”¨å¦‚ä¸‹</p>
<ul>
<li>channelä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ªfd, fdä¼šå¯è¯»å¯å†™, pollerç›‘å¬å¤šä¸ªfdä¹Ÿå°±æ˜¯ç›‘å¬å¤šä¸ªchannel</li>
<li>è®¾ç½®å›è°ƒå‡½æ•°ReadCallbackï¼Œ WriteCallback, CloseCallback, ErrorCallback</li>
<li>è®¾ç½®channelå¯è¯»å¯å†™, å…·ä½“çš„é€šè¿‡update poll eventå®ç°</li>
<li>åŸºäºpollerä¼ å›çš„reventé€‰æ‹©è°ƒç”¨å¯¹åº”å›è°ƒå‡½æ•°è¿›è¡Œå¤„ç†</li>
</ul>
<span id="more"></span>

<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Channel</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">noncopyable</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">// eventå›è°ƒå‡½æ•°ç±»å‹ï¼ŒåŒ…æ‹¬å†™å›è°ƒï¼Œå…³é—­å›è°ƒï¼Œé”™è¯¯å›è°ƒ</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> EventCallback<span class="token punctuation">;</span>
  <span class="token comment">// è¯»äº‹ä»¶å›è°ƒå‡½æ•°</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Timestamp<span class="token punctuation">)</span><span class="token operator">></span> ReadEventCallback<span class="token punctuation">;</span>

  <span class="token comment">// æ„é€ å‡½æ•°ï¼Œä¼ å…¥EventLoopå’Œç›‘å¬çš„fd</span>
  <span class="token function">Channel</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä¼ å…¥æ¥æ”¶æ—¶é—´</span>
  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>Timestamp receiveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è®¾ç½®å›è°ƒå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯å†™å›è°ƒï¼Œè¯»å›è°ƒï¼Œå…³é—­å›è°ƒï¼Œé”™è¯¯å›è°ƒ</span>
  <span class="token keyword">void</span> <span class="token function">setReadCallback</span><span class="token punctuation">(</span>ReadEventCallback cb<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> readCallback_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">setWriteCallback</span><span class="token punctuation">(</span>EventCallback cb<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> writeCallback_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">setCloseCallback</span><span class="token punctuation">(</span>EventCallback cb<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> closeCallback_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">setErrorCallback</span><span class="token punctuation">(</span>EventCallback cb<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> errorCallback_ <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">/// ä¼ å…¥shared_ptrå¯¹è±¡ ç»‘å®šconst std::shared_ptr&lt;void>&amp; obj</span>
  <span class="token keyword">void</span> <span class="token function">tie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">int</span> <span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> fd_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">int</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> events_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">void</span> <span class="token function">set_revents</span><span class="token punctuation">(</span><span class="token keyword">int</span> revt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> revents_ <span class="token operator">=</span> revt<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// used by pollers</span>
  <span class="token comment">// int revents() const &#123; return revents_; &#125;</span>
  <span class="token keyword">bool</span> <span class="token function">isNoneEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> events_ <span class="token operator">==</span> kNoneEvent<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// è®¾ç½®è¯¥é€šé“çš„eventå¯è¯»ï¼Œå¯å†™ç­‰ï¼Œå¹¶å‘pollerä¸­æ›´æ–°ä¹‹</span>
  <span class="token keyword">void</span> <span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> events_ <span class="token operator">|=</span> kReadEvent<span class="token punctuation">;</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">disableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> events_ <span class="token operator">&amp;=</span> <span class="token operator">~</span>kReadEvent<span class="token punctuation">;</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> events_ <span class="token operator">|=</span> kWriteEvent<span class="token punctuation">;</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">disableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> events_ <span class="token operator">&amp;=</span> <span class="token operator">~</span>kWriteEvent<span class="token punctuation">;</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">disableAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> events_ <span class="token operator">=</span> kNoneEvent<span class="token punctuation">;</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  
  <span class="token keyword">bool</span> <span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> events_ <span class="token operator">&amp;</span> kWriteEvent<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">bool</span> <span class="token function">isReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> events_ <span class="token operator">&amp;</span> kReadEvent<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// for Poller</span>
  <span class="token keyword">int</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> index_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token comment">/// è®¾ç½®</span>
  <span class="token keyword">void</span> <span class="token function">set_index</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> index_ <span class="token operator">=</span> idx<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// for debug</span>
  string <span class="token function">reventsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  string <span class="token function">eventsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">doNotLogHup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> logHup_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  EventLoop<span class="token operator">*</span> <span class="token function">ownerLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> loop_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">static</span> string <span class="token function">eventsToString</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// æ›´æ–°channel</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">handleEventWithGuard</span><span class="token punctuation">(</span>Timestamp receiveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// ä¸‰ç§event, ç©ºäº‹ä»¶, è¯»äº‹ä»¶, å†™äº‹ä»¶</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kNoneEvent<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kReadEvent<span class="token punctuation">;</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kWriteEvent<span class="token punctuation">;</span>

  <span class="token comment">// eventloopå¯¹è±¡</span>
  EventLoop<span class="token operator">*</span> loop_<span class="token punctuation">;</span>
  <span class="token comment">// æ–‡ä»¶æè¿°ç¬¦</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  fd_<span class="token punctuation">;</span>

  <span class="token keyword">int</span>        events_<span class="token punctuation">;</span>
  <span class="token comment">// poll ä¼ å›çš„äº‹ä»¶</span>
  <span class="token keyword">int</span>        revents_<span class="token punctuation">;</span> <span class="token comment">// it's the received event types of epoll or poll</span>
  <span class="token comment">/// pollè¦å¯¹fdè¿›è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚kdeletedç­‰</span>
  <span class="token keyword">int</span>        index_<span class="token punctuation">;</span> <span class="token comment">// used by Poller.</span>
  <span class="token keyword">bool</span>       logHup_<span class="token punctuation">;</span>

  <span class="token comment">// ç»‘å®šå¯¹è±¡çš„è½¯è¿æ¥</span>
  std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> tie_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> tied_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> eventHandling_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> addedToLoop_<span class="token punctuation">;</span>

  <span class="token comment">// å›è°ƒå‡½æ•°</span>
  ReadEventCallback readCallback_<span class="token punctuation">;</span>
  EventCallback writeCallback_<span class="token punctuation">;</span>
  EventCallback closeCallback_<span class="token punctuation">;</span>
  EventCallback errorCallback_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>channel.cc</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// å‘pollæ›´æ–°event(å³channel)</span>
<span class="token keyword">void</span> <span class="token class-name">Channel</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  addedToLoop_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  loop_<span class="token operator">-></span><span class="token function">updateChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// åŸºäºpollè¿”å›çš„äº‹ä»¶, å¤„ç†ç›¸å…³äº‹ä»¶çš„å›è°ƒå‡½æ•°</span>
<span class="token keyword">void</span> <span class="token class-name">Channel</span><span class="token double-colon punctuation">::</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>Timestamp receiveTime<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> guard<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tied_<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// å¦‚æœç»‘å®šäº†å¯¹è±¡ï¼Œè¦çœ‹å¯¹è±¡æ˜¯å¦å­˜æ´»</span>
    <span class="token comment">// å¦‚æœå¯¹è±¡å­˜åœ¨ï¼Œlock()å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘å…±äº«å¯¹è±¡çš„shared_ptrï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºshared_ptrã€‚</span>
    guard <span class="token operator">=</span> tie_<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">handleEventWithGuard</span><span class="token punctuation">(</span>receiveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">handleEventWithGuard</span><span class="token punctuation">(</span>receiveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// æ ¹æ®poll å‘æ¥çš„revents_, æ‰§è¡Œå„ç§å›è°ƒå‡½æ•°</span>
<span class="token comment">// å›è°ƒå‡½æ•°ç±»å‹, closeCallback_, errorCallback_, readCallback_, writeCallback_</span>
<span class="token keyword">void</span> <span class="token class-name">Channel</span><span class="token double-colon punctuation">::</span><span class="token function">handleEventWithGuard</span><span class="token punctuation">(</span>Timestamp receiveTime<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  eventHandling_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token function">reventsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> POLLHUP<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logHup_<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      LOG_WARN <span class="token operator">&lt;&lt;</span> <span class="token string">"fd = "</span> <span class="token operator">&lt;&lt;</span> fd_ <span class="token operator">&lt;&lt;</span> <span class="token string">" Channel::handle_event() POLLHUP"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closeCallback_<span class="token punctuation">)</span> <span class="token function">closeCallback_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> POLLNVAL<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_WARN <span class="token operator">&lt;&lt;</span> <span class="token string">"fd = "</span> <span class="token operator">&lt;&lt;</span> fd_ <span class="token operator">&lt;&lt;</span> <span class="token string">" Channel::handle_event() POLLNVAL"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POLLERR <span class="token operator">|</span> POLLNVAL<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCallback_<span class="token punctuation">)</span> <span class="token function">errorCallback_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POLLIN <span class="token operator">|</span> POLLPRI <span class="token operator">|</span> POLLRDHUP<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readCallback_<span class="token punctuation">)</span> <span class="token function">readCallback_</span><span class="token punctuation">(</span>receiveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>revents_ <span class="token operator">&amp;</span> POLLOUT<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeCallback_<span class="token punctuation">)</span> <span class="token function">writeCallback_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  eventHandling_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="eventloop-h"><a href="#eventloop-h" class="headerlink" title="eventloop.h"></a>eventloop.h</h4><ul>
<li><p>æ¯ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ†é…ä¸€ä¸ªeventloopå¯¹è±¡, åŒæ—¶è®°å½•è¯¥çº¿ç¨‹çš„idï¼Œä»è€Œå°†çº¿ç¨‹äºeventloopå¯¹è±¡è¿›è¡Œç»‘å®š, ä¹Ÿå°±æ˜¯one thread one loop</p>
</li>
<li><p>eventloopå¯¹è±¡æœ‰æ³¨å†Œçš„channel, ç›‘å¬æ³¨å†Œçš„fd, å¦‚æœå‘ç”Ÿäº‹ä»¶ä¼šè¿”å›å¹¶å¤„ç†äº‹ä»¶å›è°ƒå‡½æ•°ã€‚å¤„ç†è¯¥äº‹ä»¶å›è°ƒå‡½æ•°æ˜¯å•çº¿ç¨‹çš„ã€‚ä¸»çº¿ç¨‹çš„eventloopä¼šæ³¨å†Œç›‘å¬è¿æ¥çš„äº‹ä»¶ï¼Œè€Œå»ºç«‹è¿æ¥åä¼šåœ¨å·¥ä½œçº¿ç¨‹ä¸­æ³¨å†Œå¤„ç†è¯¥è¿æ¥çš„äº‹ä»¶ã€‚</p>
</li>
<li><p>å¯¹äºä¸€ä¸ªçº¿ç¨‹, å®ƒæ‰§è¡Œçš„loopå¯¹è±¡è¦ä¹ˆæ˜¯å®ƒè‡ªå·±çš„, è¦ä¹ˆæ˜¯åˆ«äººçš„ã€‚<strong>å°½ç®¡æ¯ä¸ªçº¿ç¨‹ä¼šåˆ†é…ä¸€ä¸ªeventloopå¯¹è±¡, ä½†è¯¥çº¿ç¨‹æœ‰å¯èƒ½è°ƒç”¨å…¶ä»–çº¿ç¨‹çš„eventloopå¯¹è±¡</strong>ï¼Œ æ­¤æ—¶è¯¥çº¿ç¨‹ä¸å¯æ‰§è¡Œ, å¿…é¡»å°†ä»»åŠ¡æ”¾åˆ°å…¶ä»–çº¿ç¨‹çš„pendingFunctors_ä¸­ç­‰å¾…å…¶ä»–çº¿ç¨‹æ¥è°ƒç”¨è¯¥ä»»åŠ¡ã€‚ æ­¤ä¸¾ç§°ä¹‹ä¸º<code>runInLoop</code>ã€‚ä¾‹å¦‚serverå¯èƒ½åˆ›å»ºå­çº¿ç¨‹æ¥å¤„ç†è¿æ¥, serverå¯èƒ½ä¼šè°ƒç”¨å­çº¿ç¨‹çš„loopæ¥åˆå§‹åŒ–, ä½†ä¸å¯è°ƒç”¨å­çº¿ç¨‹æ‰§è¡Œtask(é˜²æ­¢ä¸¤ä¸ªçº¿ç¨‹ç«äº‰), å¿…é¡»å°†taskæ”¾å…¥pendingFunctorsä¸­ç­‰å­çº¿ç¨‹å‰æ¥æ‰§è¡Œã€‚</p>
</li>
<li><p>muduoçš„å¤šçº¿ç¨‹åè°ƒæ˜¯ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹çš„åè°ƒ, å¤§å¤§å‡å°‘å¤šçº¿ç¨‹è°ƒåº¦çš„ç«äº‰ã€‚</p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">EventLoop</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">noncopyable</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span> Functor<span class="token punctuation">;</span>

  <span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token comment">/// Loops forever.</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Must be called in the same thread as creation of the object.</span>
  <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Quits loop.</span>
  <span class="token comment">/// This is not 100% thread safe, if you call through a raw pointer,</span>
  <span class="token comment">/// better to call through shared_ptr&lt;EventLoop> for 100% safety.</span>
  <span class="token keyword">void</span> <span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Time when poll returns, usually means data arrival.</span>
  Timestamp <span class="token function">pollReturnTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> pollReturnTime_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">int64_t</span> <span class="token function">iteration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> iteration_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">/// Runs callback immediately in the loop thread.</span>
  <span class="token comment">/// It wakes up the loop, and run the cb.</span>
  <span class="token comment">/// If in the same loop thread, cb is run within the function.</span>
  <span class="token comment">/// Safe to call from other threads.</span>
  <span class="token keyword">void</span> <span class="token function">runInLoop</span><span class="token punctuation">(</span>Functor cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// Queues callback in the loop thread.</span>
  <span class="token comment">/// Runs after finish pooling.</span>
  <span class="token comment">/// Safe to call from other threads.</span>
  <span class="token keyword">void</span> <span class="token function">queueInLoop</span><span class="token punctuation">(</span>Functor cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

  size_t <span class="token function">queueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token comment">// timers, è®¾ç½®å®šæ—¶å™¨ä»»åŠ¡</span>
  TimerId <span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp time<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Runs callback after @c delay seconds.</span>
  <span class="token comment">/// Safe to call from other threads.</span>
  <span class="token comment">///</span>
  TimerId <span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Runs callback every @c interval seconds.</span>
  <span class="token comment">/// Safe to call from other threads.</span>
  <span class="token comment">///</span>
  TimerId <span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">///</span>
  <span class="token comment">/// Cancels the timer.</span>
  <span class="token comment">/// Safe to call from other threads.</span>
  <span class="token comment">///</span>
  <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span>TimerId timerId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// internal usage</span>
  <span class="token comment">/// æ›´æ–°channelï¼Œå°±æ˜¯æ›´æ–°éœ€è¦pollçš„è¿æ¥ï¼Œå› æ­¤è°ƒç”¨pollerå†…éƒ¨å‡½æ•°å®ç°</span>
  <span class="token keyword">void</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">updateChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">removeChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> <span class="token function">hasChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// pid_t threadId() const &#123; return threadId_; &#125;</span>
  <span class="token keyword">void</span> <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">abortNotInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// å½“å‰çº¿ç¨‹idCurrentThread::tid() ä¸º æ„å»ºthread_loopçº¿ç¨‹çš„id</span>
  <span class="token keyword">bool</span> <span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> threadId_ <span class="token operator">==</span> <span class="token class-name">CurrentThread</span><span class="token double-colon punctuation">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> 
  <span class="token comment">// bool callingPendingFunctors() const &#123; return callingPendingFunctors_; &#125;</span>
  <span class="token keyword">bool</span> <span class="token function">eventHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> eventHandling_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">void</span> <span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">const</span> boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&amp;</span> context<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> context_ <span class="token operator">=</span> context<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> boost<span class="token double-colon punctuation">::</span>any<span class="token operator">&amp;</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> context_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  boost<span class="token double-colon punctuation">::</span>any<span class="token operator">*</span> <span class="token function">getMutableContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>context_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">static</span> EventLoop<span class="token operator">*</span> <span class="token function">getEventLoopOfCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// EventLoopå¯¹è±¡åˆ›å»ºè€…å¹¶éæœ¬çº¿ç¨‹</span>
  <span class="token keyword">void</span> <span class="token function">abortNotInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// read waked up fd_</span>
  <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// waked up</span>
  <span class="token comment">// è¿è¡Œç­‰å¾…çš„ä»»åŠ¡</span>
  <span class="token keyword">void</span> <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰“å°ChannelList activeChannels_;</span>
  <span class="token keyword">void</span> <span class="token function">printActiveChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span> <span class="token comment">// DEBUG</span>

  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">></span> ChannelList<span class="token punctuation">;</span>
  <span class="token comment">// è°ƒç”¨EventLoopï¼Œè®¾ç½®ä¸ºtrue</span>
  <span class="token keyword">bool</span> looping_<span class="token punctuation">;</span> <span class="token comment">/* atomic */</span>
  std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> quit_<span class="token punctuation">;</span>
  <span class="token comment">// å¤„ç†äº‹ä»¶ä¸­</span>
  <span class="token keyword">bool</span> eventHandling_<span class="token punctuation">;</span> <span class="token comment">/* atomic */</span>
  <span class="token keyword">bool</span> callingPendingFunctors_<span class="token punctuation">;</span> <span class="token comment">/* atomic */</span>
  <span class="token comment">// è¿­ä»£æ¬¡æ•°</span>
  <span class="token keyword">int64_t</span> iteration_<span class="token punctuation">;</span>
  <span class="token comment">/// tid</span>
  <span class="token keyword">const</span> pid_t threadId_<span class="token punctuation">;</span>
  <span class="token comment">// pollReturnTime_ æ—¶é—´æˆ³</span>
  Timestamp pollReturnTime_<span class="token punctuation">;</span>
  <span class="token comment">/// pollerå’Œæ—¶é—´é˜Ÿåˆ—</span>
  <span class="token comment">/// Pollerç”¨æ¥ç›‘å¬channel</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Poller<span class="token operator">></span> poller_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TimerQueue<span class="token operator">></span> timerQueue_<span class="token punctuation">;</span>

  <span class="token keyword">int</span> wakeupFd_<span class="token punctuation">;</span>
  <span class="token comment">// unlike in TimerQueue, which is an internal class,</span>
  <span class="token comment">// we don't expose Channel to client.</span>
  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>Channel<span class="token operator">></span> wakeupChannel_<span class="token punctuation">;</span>

  boost<span class="token double-colon punctuation">::</span>any context_<span class="token punctuation">;</span>

  <span class="token comment">// scratch variables</span>
  ChannelList activeChannels_<span class="token punctuation">;</span>
  Channel<span class="token operator">*</span> currentActiveChannel_<span class="token punctuation">;</span>

  <span class="token keyword">mutable</span> MutexLock mutex_<span class="token punctuation">;</span>
  <span class="token comment">/// ä»»åŠ¡é˜Ÿåˆ—</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Functor<span class="token operator">></span> pendingFunctors_ <span class="token function">GUARDED_BY</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<p>EventLoop.cpp</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œevent_loop</span>
__thread EventLoop<span class="token operator">*</span> t_loopInThisThread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> kPollTimeMs <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token comment">/// eventfd</span>
<span class="token comment">// åœ¨Linuxç³»ç»Ÿä¸­ï¼Œeventfdæ˜¯ä¸€ä¸ªç”¨æ¥é€šçŸ¥äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œtimerfdæ˜¯çš„å®šæ—¶å™¨äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</span>
<span class="token comment">/// eventfdç”¨æ¥è§¦å‘äº‹ä»¶é€šçŸ¥ï¼Œtimerfdç”¨æ¥è§¦å‘å°†æ¥çš„äº‹ä»¶é€šçŸ¥ã€‚</span>

<span class="token comment">// eventfdåœ¨å†…æ ¸é‡Œçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨counterï¼Œå®ƒæ˜¯ä¸€ä¸ªuint64_tçš„æ•´å½¢å˜é‡counterï¼Œåˆå§‹å€¼ä¸ºinitvalã€‚</span>
<span class="token comment">// readæ“ä½œ å¦‚æœå½“å‰counter > 0ï¼Œé‚£ä¹ˆreadè¿”å›counterå€¼ï¼Œå¹¶é‡ç½®counterä¸º0ï¼›å¦‚æœå½“å‰counterç­‰äº0ï¼Œé‚£ä¹ˆread 1)é˜»å¡ç›´åˆ°counterå¤§äº0</span>
<span class="token comment">// writeæ“ä½œ writeå°è¯•å°†valueåŠ åˆ°counterä¸Šã€‚writeå¯ä»¥å¤šæ¬¡è¿ç»­è°ƒç”¨ï¼Œä½†readè¯»ä¸€æ¬¡å³å¯æ¸…é›¶</span>
<span class="token keyword">int</span> <span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> evtfd <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK <span class="token operator">|</span> EFD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>evtfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_SYSERR <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed in eventfd"</span><span class="token punctuation">;</span>
    <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> evtfd<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// å½“å‰çº¿ç¨‹çš„eventloop</span>
EventLoop<span class="token operator">*</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">getEventLoopOfCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> t_loopInThisThread<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">looping_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">quit_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">eventHandling_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">callingPendingFunctors_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">iteration_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// æ„é€ thread_loopçš„çº¿ç¨‹id</span>
    <span class="token function">threadId_</span><span class="token punctuation">(</span><span class="token class-name">CurrentThread</span><span class="token double-colon punctuation">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token function">poller_</span><span class="token punctuation">(</span><span class="token class-name">Poller</span><span class="token double-colon punctuation">::</span><span class="token function">newDefaultPoller</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">timerQueue_</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TimerQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// åˆ›å»ºwakeupFd_</span>
    <span class="token function">wakeupFd_</span><span class="token punctuation">(</span><span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/// åˆ›å»ºä¸€ä¸ªwakeChannel, ç”¨æ¥æ¥æ”¶wakeupçš„socket</span>
    <span class="token function">wakeupChannel_</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> wakeupFd_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">currentActiveChannel_</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  LOG_DEBUG <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop created "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" in thread "</span> <span class="token operator">&lt;&lt;</span> threadId_<span class="token punctuation">;</span>
  <span class="token comment">/// å½“å‰çº¿ç¨‹å·²ç»æœ‰eventloopå¯¹è±¡äº†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t_loopInThisThread<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_FATAL <span class="token operator">&lt;&lt;</span> <span class="token string">"Another EventLoop "</span> <span class="token operator">&lt;&lt;</span> t_loopInThisThread
              <span class="token operator">&lt;&lt;</span> <span class="token string">" exists in this thread "</span> <span class="token operator">&lt;&lt;</span> threadId_<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    t_loopInThisThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// eventloopä¼šé˜»å¡åœ¨epoll_wait, è¢«å”¤é†’ä¹‹åè°ƒç”¨çš„å›è°ƒå‡½æ•°</span>
  <span class="token comment">/// wakeupChannel_ è¯»çš„å›è°ƒå‡½æ•°</span>
  wakeupChannel_<span class="token operator">-></span><span class="token function">setReadCallback</span><span class="token punctuation">(</span>
      std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EventLoop<span class="token double-colon punctuation">::</span>handleRead<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// wakeupfdå¯è¯», å¹¶è°ƒpoller ->updateä¸­æ›´æ–°ä¹‹</span>
  wakeupChannel_<span class="token operator">-></span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  LOG_DEBUG <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" of thread "</span> <span class="token operator">&lt;&lt;</span> threadId_
            <span class="token operator">&lt;&lt;</span> <span class="token string">" destructs in thread "</span> <span class="token operator">&lt;&lt;</span> <span class="token class-name">CurrentThread</span><span class="token double-colon punctuation">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  wakeupChannel_<span class="token operator">-></span><span class="token function">disableAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  wakeupChannel_<span class="token operator">-></span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span>wakeupFd_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  t_loopInThisThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// EventLoopçš„loopå¾ªç¯</span>
<span class="token comment">/// loopæ˜¯é’ˆå¯¹æœåŠ¡å™¨çš„, éœ€è¦å¤„ç†å¤§é‡å®¢æˆ·ç«¯çš„å¤„ç†çš„å›è°ƒå‡½æ•°ã€‚æ‰§è¡Œloopç®¡ç†çº¿ç¨‹éœ€è¦one thread one loop, ä½†æ‰§è¡Œè¿™äº›å›è°ƒå‡½æ•°æ˜¯å¯ä»¥å¤šçº¿ç¨‹çš„</span>

<span class="token comment">/// ä¼šæœ‰ä¸ªçº¿ç¨‹æ± æ‰§è¡Œå¤§é‡eventloop, åŒæ—¶è¿™äº›çº¿ç¨‹å¯ä»¥æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—çš„å‡½æ•°</span>

<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>looping_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// è¯¥çº¿ç¨‹æ˜¯åˆ›å»ºeventloopçš„çº¿ç¨‹</span>
  <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  looping_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  quit_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// FIXME: what if someone calls quit() before loop() ?</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" start looping"</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>quit_<span class="token punctuation">)</span>
  <span class="token comment">/// loopå¾ªç¯æœªç»ˆæ­¢</span>
  <span class="token punctuation">&#123;</span>

    <span class="token comment">/// ä½¿ç”¨poller_->pollè·å–æ´»è·ƒçš„fdæ‰€å±çš„activeChannels_ï¼Œè°ƒç”¨æ³¨å†Œå›è°ƒå‡½æ•°handleEventã€‚</span>
    activeChannels_<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// ä¸€èˆ¬çš„ä¼šé˜»å¡åœ¨pollç›´åˆ°æœ‰æ´»è·ƒçš„channel</span>
    pollReturnTime_ <span class="token operator">=</span> poller_<span class="token operator">-></span><span class="token function">poll</span><span class="token punctuation">(</span>kPollTimeMs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>activeChannels_<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token operator">++</span>iteration_<span class="token punctuation">;</span>
    <span class="token comment">/// æ‰“å°æ´»è·ƒçš„channel</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Logger</span><span class="token double-colon punctuation">::</span><span class="token function">logLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> Logger<span class="token double-colon punctuation">::</span>TRACE<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">printActiveChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// TODO sort channel by priority</span>
    <span class="token comment">// æ‰§è¡Œæ´»è·ƒå‡½æ•°çš„å›è°ƒå‡½æ•°</span>
    eventHandling_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel <span class="token operator">:</span> activeChannels_<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      currentActiveChannel_ <span class="token operator">=</span> channel<span class="token punctuation">;</span>
      <span class="token comment">/// å¤„ç†handleEventå‡½æ•°</span>
      currentActiveChannel_<span class="token operator">-></span><span class="token function">handleEvent</span><span class="token punctuation">(</span>pollReturnTime_<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// æ¸…ç©ºActiveChannel_</span>
    currentActiveChannel_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    eventHandling_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">/// æ³¨æ„å¦‚æœæ­¤æ—¶è¯¥EventLoopä¸­è¿Ÿè¿Ÿæ²¡æœ‰äº‹ä»¶è§¦å‘ï¼Œé‚£ä¹ˆepoll_waitä¸€ç›´å°±ä¼šé˜»å¡ã€‚ è¿™æ ·ä¼šå¯¼è‡´ï¼ŒpendingFunctors_è¿Ÿè¿Ÿä¸èƒ½è¢«æ‰§è¡Œäº†ã€‚</span>
    <span class="token comment">/// è¿™æ—¶å€™éœ€è¦å”¤é†’eventfdçš„epoll_waitï¼Œè®©poller_->pollè§£é™¤é˜»å¡</span>

    <span class="token comment">/// å¾…æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—</span>
    <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop "</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" stop looping"</span><span class="token punctuation">;</span>
  looping_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// é€€å‡ºloopå¾ªç¯</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  quit_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// å½“å‰çš„çº¿ç¨‹ä¸æ˜¯åˆ›å»ºeventloopå¯¹è±¡çš„çº¿ç¨‹, éœ€è¦ç­‰å¾…</span>
  <span class="token comment">// åˆ›å»ºeventloopå¯¹è±¡çš„çº¿ç¨‹è´Ÿè´£é”€æ¯å®ƒ</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">runInLoop</span><span class="token punctuation">(</span>Functor cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/// åˆ›å»ºeventloopçš„çº¿ç¨‹ä¸­æ‰§è¡Œcbå‡½æ•°, ä¿è¯å§‹ç»ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥å‡½æ•°, æ˜¯åˆ›å»ºè¯¥eventloopå¯¹è±¡çš„çº¿ç¨‹</span>
  <span class="token comment">/// </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>

  <span class="token punctuation">&#123;</span>
    <span class="token comment">///ä»»åŠ¡å…ˆå…¥é˜Ÿåˆ—ï¼Œç­‰eventloopçº¿ç¨‹è‡ªåŠ¨è°ƒç”¨ä¹‹</span>
    <span class="token function">queueInLoop</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å°†ä»»åŠ¡åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Functor cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/// pendingFunctors_çš„å‡½æ•°åˆ—è¡¨</span>
  <span class="token punctuation">&#123;</span>
  MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pendingFunctors_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// éioçº¿ç¨‹, æˆ–callingPendingFunctors_(è°ƒç”¨doPendingFunctorså¯è·å¾—)</span>
  <span class="token comment">/// å¦‚æœè°ƒç”¨äº†callingPendingFunctors_ï¼Œ åˆ™å†æ¬¡å”¤é†’</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> callingPendingFunctors_<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">/// å”¤é†’eventloopçš„epoll_waitç­‰å¾…äº‹ä»¶è§¦å‘, ä»è€Œè®©eventloopçº¿ç¨‹è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—pendingFunctors_ä¸­çš„å‡½æ•°</span>
    <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// ç­‰å¾…ioæ‰§è¡Œçš„å‡½æ•°å¤§å°</span>
size_t <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">queueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pendingFunctors_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å®šæ—¶å™¨, åœ¨timeæ—¶åˆ»æ‰§è¡ŒTimerCallback</span>
TimerId <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp time<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> timerQueue_<span class="token operator">-></span><span class="token function">addTimer</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å®šæ—¶å™¨, å»¶è¿Ÿæ‰§è¡ŒTimerCallback</span>
TimerId <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  Timestamp <span class="token function">time</span><span class="token punctuation">(</span><span class="token function">addTime</span><span class="token punctuation">(</span><span class="token class-name">Timestamp</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">runAt</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å®šæ—¶å™¨, æ¯é—´éš”intervalæ‰§è¡ŒTimerCallback</span>
TimerId <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> TimerCallback cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  Timestamp <span class="token function">time</span><span class="token punctuation">(</span><span class="token function">addTime</span><span class="token punctuation">(</span><span class="token class-name">Timestamp</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> timerQueue_<span class="token operator">-></span><span class="token function">addTimer</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å®šæ—¶å™¨é˜Ÿåˆ—å–æ¶ˆtimerId</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">cancel</span><span class="token punctuation">(</span>TimerId timerId<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> timerQueue_<span class="token operator">-></span><span class="token function">cancel</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// æ›´æ–°æ­¤eventloop ç›‘å¬çš„channel,åŸºäºpoller_ä¿®æ”¹fd, è¢«channelè°ƒç”¨</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">updateChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">ownerLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  poller_<span class="token operator">-></span><span class="token function">updateChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// åˆ é™¤channel, åŸºäºpoller_åˆ é™¤æ³¨å†Œçš„fd, è¢«channelè°ƒç”¨</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">removeChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">ownerLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandling_<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>currentActiveChannel_ <span class="token operator">==</span> channel <span class="token operator">||</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">find</span><span class="token punctuation">(</span>activeChannels_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> activeChannels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> channel<span class="token punctuation">)</span> <span class="token operator">==</span> activeChannels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  poller_<span class="token operator">-></span><span class="token function">removeChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// eventloop has_channel, ä¸€ä¸ªchannelæ˜¯ä¸€ä¸ªç›‘å¬çš„fd, å®é™…æ˜¯è°ƒç”¨poller_åˆ¤æ–­ç›‘å¬çš„channel</span>
<span class="token keyword">bool</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">hasChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">ownerLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> poller_<span class="token operator">-></span><span class="token function">hasChannel</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å¯¹è¿™ä¸ªwakeupFd_è¿›è¡Œå†™æ“ä½œï¼Œä»¥è§¦å‘wakeupFd_çš„å¯è¯»äº‹ä»¶ã€‚è§£é™¤loopé˜»å¡åœ¨epoll_waitã€‚</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/// ä½¿wakeupFd_å¯è¯»</span>
  ssize_t n <span class="token operator">=</span> sockets<span class="token double-colon punctuation">::</span><span class="token function">write</span><span class="token punctuation">(</span>wakeupFd_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_ERROR <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::wakeup() writes "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// wakeupFd_è¯»çš„å›è°ƒå‡½æ•°</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  ssize_t n <span class="token operator">=</span> sockets<span class="token double-colon punctuation">::</span><span class="token function">read</span><span class="token punctuation">(</span>wakeupFd_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_ERROR <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::handleRead() reads "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// è¿è¡Œä»»åŠ¡é˜Ÿåˆ—</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Functor<span class="token operator">></span> functors<span class="token punctuation">;</span>
  <span class="token comment">/// éœ€è¦å”¤é†’epoll_waitäº†</span>
  callingPendingFunctors_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">/// CASæ“ä½œï¼Œ æœ‰å¯èƒ½çº¿ç¨‹æ­£åœ¨æ‰§è¡ŒpendingFunctors_, å› æ­¤éœ€è¦CASé˜²æ­¢ç«æ€</span>
  <span class="token punctuation">&#123;</span>
  MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  functors<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>pendingFunctors_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// æ‰§è¡Œå®ŒpendingFunctors_</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Functor<span class="token operator">&amp;</span> functor <span class="token operator">:</span> functors<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">functor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  callingPendingFunctors_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// æ‰“å°activeChannels_</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoop</span><span class="token double-colon punctuation">::</span><span class="token function">printActiveChannels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Channel<span class="token operator">*</span> channel <span class="token operator">:</span> activeChannels_<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"&#123;"</span> <span class="token operator">&lt;&lt;</span> channel<span class="token operator">-></span><span class="token function">reventsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"&#125; "</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="poller"><a href="#poller" class="headerlink" title="poller"></a>poller</h4><ul>
<li>pollerç”¨æ¥ç›‘å¬å¤šä¸ªfd, ä¹Ÿå°±æ˜¯å¤šä¸ªchannel</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Channel</span><span class="token punctuation">;</span>

<span class="token comment">///</span>
<span class="token comment">/// Base class for IO Multiplexing</span>
<span class="token comment">///</span>
<span class="token comment">/// This class doesn't own the Channel objects.</span>
<span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">noncopyable</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">/// ç›‘å¬çš„channel åˆ—è¡¨</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">></span> ChannelList<span class="token punctuation">;</span>

  <span class="token comment">// ä¼ å…¥EventLoop</span>
  <span class="token function">Poller</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">Poller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// Polls the I/O events.</span>
  <span class="token comment">/// Must be called in the loop thread.</span>
  <span class="token comment">/// pollå‡½æ•°æ˜¯ä¸€ä¸ªè™šå‡½æ•°ï¼Œå…·ä½“çš„ioå¤šè·¯å¤ç”¨æ–¹æ³•poll, select, epollå¯¹å…¶é‡å†™</span>
  <span class="token comment">/// è¿”å›æ´»è·ƒçš„channel</span>
  <span class="token keyword">virtual</span> Timestamp <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMs<span class="token punctuation">,</span> ChannelList<span class="token operator">*</span> activeChannels<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/// Changes the interested I/O events.</span>
  <span class="token comment">/// Must be called in the loop thread.</span>
  <span class="token comment">/// æ›´æ–°channelçš„å‡½æ•°</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">updateChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">/// Remove the channel, when it destructs.</span>
  <span class="token comment">/// Must be called in the loop thread.</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">removeChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">hasChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> Poller<span class="token operator">*</span> <span class="token function">newDefaultPoller</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
  <span class="token punctuation">&#123;</span>
    ownerLoop_<span class="token operator">-></span><span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

 <span class="token keyword">protected</span><span class="token operator">:</span>
 <span class="token comment">/// ä¸€ä¸ªfd->channel çš„map</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Channel<span class="token operator">*</span><span class="token operator">></span> ChannelMap<span class="token punctuation">;</span>
  ChannelMap channels_<span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  EventLoop<span class="token operator">*</span> ownerLoop_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token comment">/// epoll</span>

<span class="token keyword">class</span> <span class="token class-name">EPollPoller</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Poller</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">EPollPoller</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">EPollPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
  <span class="token comment">/// é‡å†™æ–¹æ³•</span>
  Timestamp <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMs<span class="token punctuation">,</span> ChannelList<span class="token operator">*</span> activeChannels<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">updateChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">removeChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> kInitEventListSize <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">operationToString</span><span class="token punctuation">(</span><span class="token keyword">int</span> op<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// æ‰¾åˆ°æ´»è·ƒçš„channel</span>
  <span class="token keyword">void</span> <span class="token function">fillActiveChannels</span><span class="token punctuation">(</span><span class="token keyword">int</span> numEvents<span class="token punctuation">,</span>
                          ChannelList<span class="token operator">*</span> activeChannels<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  <span class="token comment">// update channel</span>
  <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span> Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// event åˆ—è¡¨, eventæ˜¯ä¸€ä¸ªepoll_event ç»“æ„ä½“</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token operator">></span> EventList<span class="token punctuation">;</span>
  <span class="token comment">/// epollæ–‡ä»¶æè¿°ç¬¦</span>
  <span class="token keyword">int</span> epollfd_<span class="token punctuation">;</span>
  <span class="token comment">/// EventList</span>
  EventList events_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>

<ul>
<li>EpollPoller.cpp</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// åˆå§‹åŒ– (1) åˆå§‹åŒ–çˆ¶ç±»Poller</span>
<span class="token comment">/// (2) åˆ›å»ºepoll_fd é€šè¿‡epoll_create1</span>
<span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">EPollPoller</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> loop<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">Poller</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">epollfd_</span><span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">epoll_create1</span><span class="token punctuation">(</span>EPOLL_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">events_</span><span class="token punctuation">(</span>kInitEventListSize<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>epollfd_ <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_SYSFATAL <span class="token operator">&lt;&lt;</span> <span class="token string">"EPollPoller::EPollPoller"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å…³é—­epollæè¿°ç¬¦</span>
<span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">EPollPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span>epollfd_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/// pollè°ƒç”¨epoll_waitè¿”å›æ´»è·ƒçš„channel</span>
Timestamp <span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeoutMs<span class="token punctuation">,</span> ChannelList<span class="token operator">*</span> activeChannels<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"fd total count "</span> <span class="token operator">&lt;&lt;</span> channels_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// è°ƒç”¨epoll_waitä»è·å–æ´»è·ƒçš„äº‹ä»¶å­˜å‚¨åˆ°events_ä¸­</span>
  <span class="token keyword">int</span> numEvents <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd_<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span><span class="token operator">*</span>events_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>events_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> savedErrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
  Timestamp <span class="token function">now</span><span class="token punctuation">(</span><span class="token class-name">Timestamp</span><span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numEvents <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_TRACE <span class="token operator">&lt;&lt;</span> numEvents <span class="token operator">&lt;&lt;</span> <span class="token string">" events happened"</span><span class="token punctuation">;</span>
    <span class="token comment">/// å°†æ´»è·ƒäº‹ä»¶æ·»åŠ åˆ°activeChannelsä¸­</span>
    <span class="token function">fillActiveChannels</span><span class="token punctuation">(</span>numEvents<span class="token punctuation">,</span> activeChannels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">implicit_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>numEvents<span class="token punctuation">)</span> <span class="token operator">==</span> events_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      events_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>events_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>numEvents <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"nothing happened"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// error happens, log uncommon ones</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>savedErrno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      errno <span class="token operator">=</span> savedErrno<span class="token punctuation">;</span>
      LOG_SYSERR <span class="token operator">&lt;&lt;</span> <span class="token string">"EPollPoller::poll()"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> now<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å°†æ´»è·ƒçš„events è½¬å‹channel, channelçš„reventså°±æ˜¯epoll_eventçš„eventæˆå‘˜, å½¢æˆactiveChannels</span>
<span class="token keyword">void</span> <span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">fillActiveChannels</span><span class="token punctuation">(</span><span class="token keyword">int</span> numEvents<span class="token punctuation">,</span>
                                     ChannelList<span class="token operator">*</span> activeChannels<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">implicit_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>numEvents<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> events_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numEvents<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">/// è½¬å‹events_[i].data.ptræŒ‡é’ˆè½¬ä¸ºchannelæŒ‡é’ˆ</span>
    Channel<span class="token operator">*</span> channel <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>events_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">NDEBUG</span></span>
    <span class="token comment">/// fd</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// åœ¨channels_ä¸­æŸ¥æ‰¾æ´»è·ƒçš„fd key</span>
    ChannelMap<span class="token double-colon punctuation">::</span>const_iterator it <span class="token operator">=</span> channels_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>it <span class="token operator">!=</span> channels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>it<span class="token operator">-></span>second <span class="token operator">==</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token comment">/// eventsæ˜¯epollæ³¨å†Œçš„äº‹ä»¶</span>
    channel<span class="token operator">-></span><span class="token function">set_revents</span><span class="token punctuation">(</span>events_<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeChannels<span class="token operator">-></span><span class="token function">push_back</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// æ›´æ–°channel, ä¹Ÿå°±æ˜¯è°ƒç”¨updateæ›´æ–°fdç›‘å¬çš„äº‹ä»¶</span>
<span class="token comment">/// fdå’Œeventsæ„æˆäº†ç›‘å¬å¯¹è±¡</span>
<span class="token keyword">void</span> <span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">updateChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">Poller</span><span class="token double-colon punctuation">::</span><span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> index <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"fd = "</span> <span class="token operator">&lt;&lt;</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;&lt;</span> <span class="token string">" events = "</span> <span class="token operator">&lt;&lt;</span> channel<span class="token operator">-></span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" index = "</span> <span class="token operator">&lt;&lt;</span> index<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> kNew <span class="token operator">||</span> index <span class="token operator">==</span> kDeleted<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// a new one, add with EPOLL_CTL_ADD</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> kNew<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/// å¯¹fdè®¾ç½®æ–°çš„channel</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">==</span> channels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      channels_<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> channel<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token comment">// index == kDeleted</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> channels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// æ·»åŠ æ“ä½œ</span>
    channel<span class="token operator">-></span><span class="token function">set_index</span><span class="token punctuation">(</span>kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// åœ¨epollä¸­æ·»åŠ æ³¨å†Œchannelçš„fd</span>
    <span class="token function">update</span><span class="token punctuation">(</span>EPOLL_CTL_ADD<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// update existing one with EPOLL_CTL_MOD/DEL</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>fd<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> channels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">isNoneEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">update</span><span class="token punctuation">(</span>EPOLL_CTL_DEL<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/// deleteæ“ä½œ</span>
      channel<span class="token operator">-></span><span class="token function">set_index</span><span class="token punctuation">(</span>kDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">update</span><span class="token punctuation">(</span>EPOLL_CTL_MOD<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// åœ¨channelmapä¸­åˆ é™¤å…³è”</span>
<span class="token keyword">void</span> <span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">removeChannel</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">Poller</span><span class="token double-colon punctuation">::</span><span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// channelçš„fd</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"fd = "</span> <span class="token operator">&lt;&lt;</span> fd<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">!=</span> channels_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channels_<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>channel<span class="token operator">-></span><span class="token function">isNoneEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> index <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kAdded <span class="token operator">||</span> index <span class="token operator">==</span> kDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>

  size_t n <span class="token operator">=</span> channels_<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// åœ¨epollä¸­åˆ é™¤channelçš„fd</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> kAdded<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">update</span><span class="token punctuation">(</span>EPOLL_CTL_DEL<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  channel<span class="token operator">-></span><span class="token function">set_index</span><span class="token punctuation">(</span>kNew<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// æ›´æ–°pollçš„fdï¼Œ ::epoll_ctlæ›´æ–°fdçš„event</span>
<span class="token keyword">void</span> <span class="token class-name">EPollPoller</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">int</span> operation<span class="token punctuation">,</span> Channel<span class="token operator">*</span> channel<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span>
  <span class="token function">memZero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// æ³¨å†Œäº‹ä»¶å¯¹è±¡çš„å…ƒç´ , events, data.ptr</span>
  event<span class="token punctuation">.</span>events <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> channel<span class="token punctuation">;</span>
  <span class="token keyword">int</span> fd <span class="token operator">=</span> channel<span class="token operator">-></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG_TRACE <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_ctl op = "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">operationToString</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span>
    <span class="token operator">&lt;&lt;</span> <span class="token string">" fd = "</span> <span class="token operator">&lt;&lt;</span> fd <span class="token operator">&lt;&lt;</span> <span class="token string">" event = &#123; "</span> <span class="token operator">&lt;&lt;</span> channel<span class="token operator">-></span><span class="token function">eventsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" &#125;"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token double-colon punctuation">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd_<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>operation <span class="token operator">==</span> EPOLL_CTL_DEL<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      LOG_SYSERR <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_ctl op ="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">operationToString</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" fd ="</span> <span class="token operator">&lt;&lt;</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      LOG_SYSFATAL <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_ctl op ="</span> <span class="token operator">&lt;&lt;</span> <span class="token function">operationToString</span><span class="token punctuation">(</span>operation<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" fd ="</span> <span class="token operator">&lt;&lt;</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="eventloopthread"><a href="#eventloopthread" class="headerlink" title="eventloopthread"></a>eventloopthread</h4><ul>
<li><p>åˆå§‹åŒ–æ—¶åœ¨threadç»‘å®šthread_(std::bind(&amp;EventLoopThread::threadFunc, this))å‡½æ•°</p>
</li>
<li><p>startLoop è°ƒç”¨<code>thread.start()</code>ä½¿çº¿ç¨‹å¼€å§‹æ‰§è¡Œã€‚å­çº¿ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªeventloopå¯¹è±¡å¹¶è°ƒç”¨loop, ä¸»çº¿ç¨‹ä¼šç­‰å¾…å­çº¿ç¨‹åˆ›å»ºå®Œloopå¯¹è±¡è¿”å›ã€‚</p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">EventLoop</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventLoopThread</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">noncopyable</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token comment">/// eventloop threadåˆ›å»ºä¹‹åçš„å›è°ƒå‡½æ•°, å‚æ•°ä¸ºvoid(EventLoop*)</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> ThreadInitCallback<span class="token punctuation">;</span>

  <span class="token function">EventLoopThread</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadInitCallback<span class="token operator">&amp;</span> cb <span class="token operator">=</span> <span class="token function">ThreadInitCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token keyword">const</span> string<span class="token operator">&amp;</span> name <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">EventLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// EventloopThreadçš„startLoop()</span>
  EventLoop<span class="token operator">*</span> <span class="token function">startLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// çº¿ç¨‹å†…éƒ¨çš„loopå¯¹è±¡</span>
  EventLoop<span class="token operator">*</span> loop_ <span class="token function">GUARDED_BY</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> exiting_<span class="token punctuation">;</span>
  <span class="token comment">// æ–°threadåˆ›å»º</span>
  Thread thread_<span class="token punctuation">;</span>
  MutexLock mutex_<span class="token punctuation">;</span>
  Condition cond_ <span class="token function">GUARDED_BY</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ThreadInitCallback callback_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token class-name">EventLoopThread</span><span class="token double-colon punctuation">::</span><span class="token function">EventLoopThread</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadInitCallback<span class="token operator">&amp;</span> cb<span class="token punctuation">,</span>
                                 <span class="token keyword">const</span> string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">loop_</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">exiting_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//åˆå§‹åŒ–æ—¶ ç»‘å®šçº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°, EventLoopThread::threadFunc</span>
    <span class="token function">thread_</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EventLoopThread<span class="token double-colon punctuation">::</span>threadFunc<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">mutex_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">cond_</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">callback_</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">EventLoopThread</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">EventLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  exiting_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>loop_ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// not 100% race-free, eg. threadFunc could be running callback_.</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// still a tiny chance to call destructed object, if threadFunc exits just now.</span>
    <span class="token comment">// but when EventLoopThread destructs, usually programming is exiting anyway.</span>
    loop_<span class="token operator">-></span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread_<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ï¼ˆä¸»çº¿ç¨‹)å¼€å¯çº¿ç¨‹(æ‰§è¡Œå‡½æ•°)</span>
EventLoop<span class="token operator">*</span> <span class="token class-name">EventLoopThread</span><span class="token double-colon punctuation">::</span><span class="token function">startLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>thread_<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¼€å¯æ–°çº¿ç¨‹threadæ‰§è¡Œstart()</span>
  <span class="token comment">/// çº¿ç¨‹æ‰§è¡Œç»‘å®šå¥½çš„å‡½æ•°, å³threadFunc()</span>
  thread_<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  EventLoop<span class="token operator">*</span> loop <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#123;</span>
    MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// mainçº¿ç¨‹ç­‰å¾…loop_</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>loop_ <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      cond_<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/// loopæœ‰äº†(æ–°çº¿ç¨‹åˆ›å»ºçš„), è¿”å›loopå¯¹è±¡</span>
    loop <span class="token operator">=</span> loop_<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// </span>
  <span class="token keyword">return</span> loop<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// æ–°çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°</span>
<span class="token keyword">void</span> <span class="token class-name">EventLoopThread</span><span class="token double-colon punctuation">::</span><span class="token function">threadFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
   <span class="token comment">/// åœ¨çº¿ç¨‹æ ˆä¸Šè¿è¡Œçš„eventloopï¼Œ åˆ›å»ºeventloopå¯¹è±¡</span>
  EventLoop loop<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback_<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// æ‰§è¡Œå›è°ƒå‡½æ•°ThreadInitCallback</span>
    <span class="token function">callback_</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#123;</span>
    MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop_ <span class="token operator">=</span> <span class="token operator">&amp;</span>loop<span class="token punctuation">;</span>
    <span class="token comment">/// å”¤é†’ä¸»çº¿ç¨‹è¿”å›loop</span>
    cond_<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// çº¿ç¨‹æ‰§è¡Œloopå¾ªç¯</span>
  loop<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//assert(exiting_);</span>
  MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  loop_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="eventloopthreadPool"><a href="#eventloopthreadPool" class="headerlink" title="eventloopthreadPool"></a>eventloopthreadPool</h4><ul>
<li>çº¿ç¨‹æ± , ç»´æŠ¤ä¸€ä¸ªthreadsåˆ—è¡¨å’ŒEventLoop*å¯¹è±¡åˆ—è¡¨</li>
<li>start(ä¼šç”Ÿæˆä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åˆ—è¡¨, åˆ›å»ºçº¿ç¨‹å¯¹è±¡å­çº¿ç¨‹æ‰§è¡Œloop, å°†å­çº¿ç¨‹å¯¹è±¡threadå’Œæ‰§è¡Œçš„loopå¯¹è±¡åŠ å…¥åˆ—è¡¨ä¸­ã€‚</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">EventLoop</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">EventLoopThread</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventLoopThreadPool</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">noncopyable</span></span>
<span class="token punctuation">&#123;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
 <span class="token comment">/// çº¿ç¨‹åˆå§‹åŒ–å›è°ƒå‡½æ•°</span>
  <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">></span> ThreadInitCallback<span class="token punctuation">;</span>

  <span class="token function">EventLoopThreadPool</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> baseLoop<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> nameArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">EventLoopThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">setThreadNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> numThreads_ <span class="token operator">=</span> numThreads<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadInitCallback<span class="token operator">&amp;</span> cb <span class="token operator">=</span> <span class="token function">ThreadInitCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// valid after calling start()</span>
  <span class="token comment">/// round-robin</span>
  EventLoop<span class="token operator">*</span> <span class="token function">getNextLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/// with the same hash code, it will always return the same EventLoop</span>
  EventLoop<span class="token operator">*</span> <span class="token function">getLoopForHash</span><span class="token punctuation">(</span>size_t hashCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>EventLoop<span class="token operator">*</span><span class="token operator">></span> <span class="token function">getAllLoops</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> <span class="token function">started</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> started_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> string<span class="token operator">&amp;</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> name_<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>

  EventLoop<span class="token operator">*</span> baseLoop_<span class="token punctuation">;</span>
  string name_<span class="token punctuation">;</span>
  
  <span class="token keyword">bool</span> started_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> numThreads_<span class="token punctuation">;</span>
  <span class="token keyword">int</span> next_<span class="token punctuation">;</span>
  <span class="token comment">/// çº¿ç¨‹åˆ—è¡¨</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>EventLoopThread<span class="token operator">>></span> threads_<span class="token punctuation">;</span>
  <span class="token comment">/// loop åˆ—è¡¨</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>EventLoop<span class="token operator">*</span><span class="token operator">></span> loops_<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token class-name">EventLoopThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">EventLoopThreadPool</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> baseLoop<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> nameArg<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">baseLoop_</span><span class="token punctuation">(</span>baseLoop<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">/// çº¿ç¨‹å</span>
    <span class="token function">name_</span><span class="token punctuation">(</span>nameArg<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">started_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">numThreads_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">next_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">EventLoopThreadPool</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">EventLoopThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Don't delete loop, it's stack variable</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// å¼€å¯çº¿ç¨‹æ± </span>
<span class="token keyword">void</span> <span class="token class-name">EventLoopThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> ThreadInitCallback<span class="token operator">&amp;</span> cb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>started_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/// å½“å‰loopåˆ›å»ºçº¿ç¨‹, ä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹</span>
  baseLoop_<span class="token operator">-></span><span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¼€å¯çº¿ç¨‹æ± </span>
  started_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»ºthreadså’Œloops</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numThreads_<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">/// buf, å‚¨å­˜çº¿ç¨‹å</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>name_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">,</span> <span class="token string">"%s%d"</span><span class="token punctuation">,</span> name_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ„é€ EventLoopThreadå¯¹è±¡, åˆå§‹åŒ–threadå¯¹è±¡æ‰§è¡Œå‡½æ•°</span>
    EventLoopThread<span class="token operator">*</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">EventLoopThread</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// threads åˆ—è¡¨</span>
    threads_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">unique_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>EventLoopThread<span class="token operator">></span></span></span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/// åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡ŒstartLoop()å‡½æ•°,å­çº¿ç¨‹åˆ›å»ºloopå¯¹è±¡å¹¶æ‰§è¡Œloop(), ä¸»çº¿ç¨‹è¿”å›å­çº¿ç¨‹çš„loopå¯¹è±¡</span>
    loops_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>t<span class="token operator">-></span><span class="token function">startLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/// ä¸åˆ›å»ºæ–°çº¿ç¨‹ï¼Œ å½“å‰çº¿ç¨‹æ‰§è¡Œcb</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>numThreads_ <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cb<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>baseLoop_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// loop æ˜¯ä¸€ä¸ªvector, å¾—åˆ°ä¸‹ä¸€ä¸ªloop(æ¯ä¸ªå­çº¿ç¨‹ä¸€ä¸ªloopå¯¹è±¡, ä¸‹ä¸€ä¸ªloopæ¯ä¸ªloopéƒ½æ¥è‡ªä¸åŒçš„çº¿ç¨‹)</span>
EventLoop<span class="token operator">*</span> <span class="token class-name">EventLoopThreadPool</span><span class="token double-colon punctuation">::</span><span class="token function">getNextLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  baseLoop_<span class="token operator">-></span><span class="token function">assertInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>started_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  EventLoop<span class="token operator">*</span> loop <span class="token operator">=</span> baseLoop_<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loops_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// round-robin</span>
    loop <span class="token operator">=</span> loops_<span class="token punctuation">[</span>next_<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>next_<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">implicit_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>size_t<span class="token operator">></span></span></span><span class="token punctuation">(</span>next_<span class="token punctuation">)</span> <span class="token operator">>=</span> loops_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      next_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> loop<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2021-08-29-muduo%E6%BA%90%E7%A0%815/" rel="prev" title="muduoç½‘ç»œåº“ 05 TimerQueue socket"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">muduoç½‘ç»œåº“ 05 TimerQueue socket</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/%E7%AE%97%E6%B3%95/2021-08-25-%E5%9B%BE%E6%9C%80%E7%9F%AD%E8%B7%AF/" rel="next" title="å›¾æœ€çŸ­è·¯"><span class="post-nav-text">å›¾æœ€çŸ­è·¯</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>å¦‚æœæ‚¨æœ‰ä»»ä½•å…³äºåšå®¢å†…å®¹çš„ç›¸å…³è®¨è®ºï¼Œæ¬¢è¿å‰å¾€ <a href="https://github.com/YunYouJun/yunyoujun.github.io/discussions" target="_blank">GitHub Discussions</a> ä¸æˆ‘äº¤æµã€‚</span><br></div><div id="valine-container"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js", () => {
  const valineConfig = {"enable":true,"appId":"K4LElSwpTJaHOOTTU6mNGCyr-gzGzoHsz","appKey":"x3d4Sv6rdTYOECKqkxg9r905","placeholder":"å¡«å†™é‚®ç®±ï¼Œå¯ä»¥æ”¶åˆ°å›å¤é€šçŸ¥å“¦ï½","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick","mail","link"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = "/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/2021-08-28-muduo%E6%BA%90%E7%A0%813/"
  new Valine(valineConfig)
}, window.Valine);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">èŒICPå¤‡666666å·</a></div><div class="copyright"><span>&copy; 2020 â€“ 2021 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="https://sponsors.yunyoujun.cn" title="äº‘æ¸¸å›çš„èµåŠ©è€…ä»¬"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></a><span class="author"> larry</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v5.4.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.6.3</span></div><div class="live_time"><span>æœ¬åšå®¢å·²èŒèŒå“’åœ°è¿è¡Œ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-04-12T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " å¤© " + passHour + " å°æ—¶ " + passMinute + " åˆ† " + passSecond + " ç§’";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="æœç´¢"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div><!-- hexo injector body_end start --><script src="/js/tag-common/index.js"></script><!-- hexo injector body_end end --></body></html>