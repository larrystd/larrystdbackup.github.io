<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><link href="/css/tag-common/index.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="larry"><meta name="copyright" content="larry"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>浅谈对象控制——AOP和反射 | 拉瑞君の小窝</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link class="aplayer-style-marker" rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.css"><script class="aplayer-script-marker" src="https://cdn.jsdelivr.net/npm/aplayer@latest/dist/APlayer.min.js" defer></script><script class="meting-script-marker" src="https://cdn.jsdelivr.net/npm/meting@1/dist/Meting.min.js" defer></script><script>document.addEventListener(
  "pjax:success",
  function() {
    if (window.aplayers) {
      loadMeting();
    }
  },
  !1
);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#6200ee"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"larrystd.github.io","root":"/","title":"拉瑞君の小窝","version":"1.6.3","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"algolia":{"appID":"CJXXAGRCYN","apiKey":"ae1966d2aeab22bf9335679f45d2cd9a","indexName":"my-hexo-blog","hits":{"per_page":8}},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="alternate" href="/atom.xml" title="拉瑞君の小窝" type="application/atom+xml"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="学习计算机过程老有一些所谓高大上的名词, 但是如果理解了会发现很简单。比如IOC控制反转, 反正不论什么名词, 都比数学简单的多。所以不要惧怕它。  这篇文章想讨论下java spring等框架一些特殊控制对象的逻辑, 以及是否适用于C++。 springSpring的两个核心概念是IOC（控制反转）和AOP（面向切面编程）。  IOC（控制翻转）是一种编程范式，可以在一定程度上解决复杂系统对象">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈对象控制——AOP和反射">
<meta property="og:url" content="https://larrystd.github.io/cpp%E8%BF%9B%E9%98%B6/2021-10-08-%E6%B5%85%E8%B0%88%E5%AF%B9%E8%B1%A1%E6%8E%A7%E5%88%B6/index.html">
<meta property="og:site_name" content="拉瑞君の小窝">
<meta property="og:description" content="学习计算机过程老有一些所谓高大上的名词, 但是如果理解了会发现很简单。比如IOC控制反转, 反正不论什么名词, 都比数学简单的多。所以不要惧怕它。  这篇文章想讨论下java spring等框架一些特殊控制对象的逻辑, 以及是否适用于C++。 springSpring的两个核心概念是IOC（控制反转）和AOP（面向切面编程）。  IOC（控制翻转）是一种编程范式，可以在一定程度上解决复杂系统对象">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://larrystd.github.io/assets/images/cpp/6.png">
<meta property="og:image" content="https://larrystd.github.io/assets/images/cpp/7.png">
<meta property="article:published_time" content="2021-10-07T16:00:00.000Z">
<meta property="article:modified_time" content="2021-10-07T16:00:00.000Z">
<meta property="article:author" content="larry">
<meta property="article:tag" content="cpp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://larrystd.github.io/assets/images/cpp/6.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="larry"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="larry"><span class="site-author-status" title="Looking for you.">🌑</span></a><div class="site-author-name"><a href="/about/">larry</a></div><a class="site-name" href="/about/site.html">拉瑞君の小窝</a><sub class="site-subtitle"></sub><div class="site-desciption">每天都是新的一天呢</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">86</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">42</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/larrystd" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/bu-qu-dou-yin-bu-gai-ming" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="Venray.Kong@outlook.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://travellings.link" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-train-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="喜欢的女孩子" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring"><span class="toc-number">1.</span> <span class="toc-text">spring</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">体系结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-%E4%BB%BF%E5%86%99Java%E7%9A%84%E5%8F%8D%E5%B0%84"><span class="toc-number">2.</span> <span class="toc-text">C++ 仿写Java的反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring%E7%9A%84bean"><span class="toc-number">3.</span> <span class="toc-text">spring的bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C-AOP"><span class="toc-number">4.</span> <span class="toc-text">C++ AOP</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://larrystd.github.io/cpp%E8%BF%9B%E9%98%B6/2021-10-08-%E6%B5%85%E8%B0%88%E5%AF%B9%E8%B1%A1%E6%8E%A7%E5%88%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="larry"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="拉瑞君の小窝"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">浅谈对象控制——AOP和反射<a class="post-edit-link" href="https://github.com/larrystd/larrystd.github.io/tree/hexo/source/_posts/cpp进阶/2021-10-08-浅谈对象控制.md" target="_blank" title="编辑" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2021-10-08 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-08T00:00:00+08:00">2021-10-08</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="本文字数">3.4k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="阅读时长">15m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/cpp-advanced/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">cpp advanced</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/cpp/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">cpp</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#6200ee;"><blockquote>
<p>学习计算机过程老有一些所谓高大上的名词, 但是如果理解了会发现很简单。比如IOC控制反转, 反正不论什么名词, 都比数学简单的多。所以不要惧怕它。</p>
</blockquote>
<p>这篇文章想讨论下java spring等框架一些特殊控制对象的逻辑, 以及是否适用于C++。</p>
<h3 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h3><p>Spring的两个核心概念是IOC（控制反转）和AOP（面向切面编程）。</p>
<ul>
<li><p>IOC（控制翻转）是一种编程范式，可以在一定程度上解决复杂系统对象耦合度太高的问题。IOC最常见的方式是DI（依赖注入, 对象依赖容器, 容器注入生成对象），可以通过一个容器，将Bean维护起来，方便在其他地方直接使用，而不是重新new。我理解的一般是通过XML配置文件, 写明对象的成员, 方法依赖关系, IOC容器会自动配置对象不用程序员new。这里的Bean可以视为一种特殊的对象, 有特定的规范(比如具有set.., get..这些), 统一格式方便进行处理。</p>
</li>
<li><p>AOP（Aspect-OrientedProgramming，面向方面编程）, 基本思路是将共同调用的逻辑或责任封装起来，便于减少系统的重复代码(例如多个对象都需要引入日志行为, 鉴权)。一个可行的办法是使用代理, 将业务相同的逻辑逻辑经由代理类分发(代理类可以理解为中介)。换言之, 对象作为参数传入代理类, 代理类对所有对象先执行日志行为, 再调用对象方法, 就实现了公用逻辑(日志)的通用。一般传入对象使用反射字符串, 可以运行时按需运行对象(有反射这样称为动态代理)。但<strong>单纯的AOP思想, 完全可以用C++的回调函数实现</strong>。</p>
</li>
</ul>
<span id="more"></span>

<h4 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h4><p><img src="../../assets/images/cpp/6.png" alt="avatar" loading="lazy"></p>
<ul>
<li>核心容器：核心容器的主要组件是 BeanFactory，它是工厂模式的实现。BeanFactory 使用控制反转 （IOC） 根据配置构建对象。</li>
<li>Spring context包括 JNDI、EJB、电子邮件、国际化、校验和调度功能。</li>
<li>Spring AOP：给 Spring 框架管理的任何对象支持 AOP。</li>
<li>Spring DAO：JDBC DAO 抽象层提供管理异常处理和不同数据库供应商抛出的错误消息。</li>
<li>Spring ORM：Spring 框架插入了若干个 ORM 框架</li>
<li>Spring Web 模块：Web 上下文模块建立在应用程序上下文模块之上，为基于 Web 的应用程序提供了上下文。</li>
<li>Spring MVC 框架：MVC 框架是一个全功能的构建 Web 应用程序的 MVC 实现</li>
</ul>
<h3 id="C-仿写Java的反射"><a href="#C-仿写Java的反射" class="headerlink" title="C++ 仿写Java的反射"></a>C++ 仿写Java的反射</h3><p>Java反射的作用是在运行期生成对象, 这常常在web开发中使用。例如程序运行期间可以基于到来的连接来生成对象处理, 相比于静态生成对象这增加了灵活性, 不用开始一直创建这个对象耗费大量资源。当然, 这牺牲了效率。</p>
<p>反射的实现需要解决以下问题</p>
<ol>
<li>运行期创建对象</li>
<li>对象可以通过接收字符串创建</li>
</ol>
<p>Java对以上是支持的, JVM本身支持运行时基于字符串导入<code>.class</code>文件解析创建对象。例如</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> price<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">int</span> price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception<span class="token punctuation">&#123;</span>
        <span class="token comment">//正常的调用</span>
        Apple apple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        apple<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Apple Price:"</span> <span class="token operator">+</span> apple<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用反射调用</span>
        <span class="token comment">/// 输入字符串"com.chenshuyi.api.Apple"(表示class路径)</span>
        Class clz <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.chenshuyi.api.Apple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/// 运行时获取方法</span>
        Method setPriceMethod <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"setPrice"</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Constructor appleConstructor <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object appleObj <span class="token operator">=</span> appleConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        setPriceMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>appleObj<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Method getPriceMethod <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getPrice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Apple Price:"</span> <span class="token operator">+</span> getPriceMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>appleObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>以上, 可以将<code>Class.forName</code>的字符串参数作为输入, 例如当某个连接到来则输入某个字符串, <code>Class.forName</code>就可以根据此创建对象, 比较灵活。</p>
<p>C++ 是做不到Java反射那么灵活的, 虽然它可以运行时创建对象(在堆上), 但并不能动态的接受字符串创建对象, 它创建的对象都是编译前写好的(不能运行时接受一个字符串来创建)。这一步可以模拟, 最终也能实现运行期间获取元素自动生成对象。</p>
<ul>
<li><p>RegisterAction类, 构造函数接受一个字符串和工厂函数(return new object那种), 将它们注册到<code>&lt;string, func&gt;</code>的map中。这实现了通过字符串调工厂函数进而获得对象。</p>
</li>
<li><p>利用宏定义的#, 可以将字面量看成字符串,进而注册RegisterAction。 `RegisterAction g_creatorRegister##className(                        \</p>
<pre><code>  #className,(PTRCreateObject)objectCreator##className)`, 将字符串`#className`, 与字符串代表的类工厂函数绑定。
</code></pre>
</li>
<li><p>对注册完毕的<code>&lt;string, func&gt;</code>map, 用户可以直接通过string调用func得到对象。</p>
</li>
<li><p>对象是当用户string调用func时创建的,但使用的是new, Java反射不是使用的new创建对象。(Java反射和new都是通过类加载器对.class文件加载进内存中，创建了Class对象。)，java反射按需加载.class文件, C++借用工厂回调函数按需new对象。</p>
</li>
</ul>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/// 函数指针的typedef</span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>PTRCreateObject<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">ClassFactory</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>  
    map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> PTRCreateObject<span class="token operator">></span> m_classMap <span class="token punctuation">;</span>  
	<span class="token function">ClassFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//构造函数私有化, 不能外界调用</span>
	
<span class="token keyword">public</span><span class="token operator">:</span>   
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">getClassByName</span><span class="token punctuation">(</span>string className<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">void</span> <span class="token function">registClass</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> PTRCreateObject method<span class="token punctuation">)</span> <span class="token punctuation">;</span> 
    <span class="token comment">/// getInstance是静态对象 </span>
    <span class="token keyword">static</span> ClassFactory<span class="token operator">&amp;</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token class-name">ClassFactory</span><span class="token double-colon punctuation">::</span><span class="token function">getClassByName</span><span class="token punctuation">(</span>string className<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
    map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> PTRCreateObject<span class="token operator">></span><span class="token double-colon punctuation">::</span>const_iterator iter<span class="token punctuation">;</span>  
    iter <span class="token operator">=</span> m_classMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span> iter <span class="token operator">==</span> m_classMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  
        <span class="token keyword">return</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>  
    <span class="token keyword">else</span>  
        <span class="token keyword">return</span> iter<span class="token operator">-></span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  

<span class="token comment">/// 注册实例到class_map中, 可以通过字符串调用之</span>
<span class="token comment">/// 注册的是一个对象获取函数PTRCreateObject, 而不是对象</span>
<span class="token comment">/// 对象知道使用getClassByName, 将PTRCreateObject强制转换成TestClass才会调用之</span>
<span class="token comment">/// 显然以上运行时才产生对象, 且根据string获取对象, 反射规则</span>
<span class="token comment">/// 这种可以实现类似动态的来了一个连接创建对象, 关闭连接释放对象, 不用一开始保留很多对象。因此在spring类似web框架应用广泛</span>
<span class="token keyword">void</span> <span class="token class-name">ClassFactory</span><span class="token double-colon punctuation">::</span><span class="token function">registClass</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> PTRCreateObject method<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
    m_classMap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">pair</span><span class="token generic class-name"><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> PTRCreateObject<span class="token operator">></span></span></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  


ClassFactory<span class="token operator">&amp;</span> <span class="token class-name">ClassFactory</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/// 静态对象, 返回静态对象的引用</span>
    <span class="token keyword">static</span> ClassFactory sLo_factory<span class="token punctuation">;</span>  
    <span class="token keyword">return</span> sLo_factory <span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  

<span class="token keyword">class</span> <span class="token class-name">RegisterAction</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">RegisterAction</span><span class="token punctuation">(</span>string className<span class="token punctuation">,</span>PTRCreateObject ptrCreateFn<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ok2\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/// 调用ClassFactory, 获取工厂实例,调用registClass注册之     </span>
		<span class="token class-name">ClassFactory</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span>ptrCreateFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>


<span class="token comment">/*
#表示字符串化操作符（stringification）。其作用是：将宏定义中的传入参数名转换成用一对双引号括起来参数名字符串。
##表示连接 

使用宏定义可以实现字符串形式
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REGISTER</span><span class="token expression"><span class="token punctuation">(</span>className<span class="token punctuation">)</span> 											</span><span class="token punctuation">\</span>
	<span class="token expression">className<span class="token operator">*</span> objectCreator</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">className</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>     							</span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"ok\n"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">return</span> <span class="token keyword">new</span> className<span class="token punctuation">;</span>                                         	</span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#125;</span>                                                                   </span><span class="token punctuation">\</span>
    <span class="token expression">RegisterAction g_creatorRegister</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">className</span><span class="token punctuation">(</span>                        </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">class</span><span class="token expression">Name<span class="token punctuation">,</span><span class="token punctuation">(</span>PTRCreateObject<span class="token punctuation">)</span>objectCreator</span></span></span><span class="token punctuation">##</span><span class="token expression">className<span class="token punctuation">)</span>   </span><span class="token comment">///(#className,(PTRCreateObject)objectCreator##className) 初始化一个RegisterAction对象</span></span>
    <span class="token comment">/// 注意这里只是将函数作为参数用来构造RegisterAction实例</span>

<span class="token comment">// test class</span>
<span class="token keyword">class</span> <span class="token class-name">TestClass</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">m_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		cout<span class="token operator">&lt;&lt;</span><span class="token string">"hello TestClass"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token function">REGISTER</span><span class="token punctuation">(</span>TestClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	TestClass<span class="token operator">*</span> ptrObj<span class="token operator">=</span><span class="token punctuation">(</span>TestClass<span class="token operator">*</span><span class="token punctuation">)</span><span class="token class-name">ClassFactory</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassByName</span><span class="token punctuation">(</span><span class="token string">"TestClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//ptrObj->m_print();</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="spring的bean"><a href="#spring的bean" class="headerlink" title="spring的bean"></a>spring的bean</h3><p><img src="../../assets/images/cpp/7.png" alt="avatar" loading="lazy"></p>
<ol>
<li><p>实例化Bean<br>对于BeanFactory容器，当客户向容器请求一个尚未初始化的bean时，或初始化bean的时候需要注入另一个尚未初始化的依赖时，容器就会调用createBean进行实例化。</p>
</li>
<li><p>设置对象属性（依赖注入）<br>实例化后的对象被封装在BeanWrapper对象中，并且此时对象仍然是一个原生的状态，并没有初始化。紧接着，Spring根据BeanDefinition中的信息进行依赖注入。</p>
</li>
<li><p>注入Aware接口<br>紧接着，Spring会检测该对象是否实现了xxxAware接口，并将相关的xxxAware实例注入给bean。</p>
</li>
<li><p>当经过上述几个步骤后，bean对象已经被正确构造，但如果你想要对象被使用前再进行一些自定义的处理，就可以通过BeanPostProcessor接口实现。</p>
</li>
</ol>
<h3 id="C-AOP"><a href="#C-AOP" class="headerlink" title="C++ AOP"></a>C++ AOP</h3><ul>
<li>基本思路是传递一些切片类型作为都执行的, 例如日志类等。这些可以放在模板类型参数中</li>
<li>然后再形参里传递要执行的函数。中间经过代理类整合成正常的函数。</li>
</ul>
<p>以下代码涉及一些C++高级特性</p>
<ul>
<li><code>auto check(int) -&gt;</code></li>
<li><code>decltype</code></li>
<li><code>std::declval&lt;U&gt;().member</code>, 可以调用U类的成员函数</li>
<li><code>std::is_same&lt;decltype(check&lt;T&gt;(0))</code>, <code>std::true_type&gt;::value</code>, 比较，类型是否相同, 相同::value为true</li>
<li><code>typename std::enable_if&lt;HasMember_before&lt;T, Args...&gt;::value &amp;&amp; HasMember_after&lt;T, Args...&gt;::value&gt;::type</code>, std::enable_if</li>
</ul>
<p>CppAop.hpp</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__CPPAOP_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__CPPAOP_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>

<span class="token keyword">namespace</span> CppAop <span class="token punctuation">&#123;</span>

<span class="token comment">/*  std::declval返回一个类型的右值引用, 并可以访问模板类的成员函数

std::is_same
位于头文件&lt;type_traits>中, 两个一样的类型会返回true
bool isInt = std::is_same&lt;int, int>::value; //为true

value是 = std::is_same&lt;decltype(check&lt;T>(0)), std::true_type>::value   , 也就是decltype(check&lt;T>(0))类型和std::true_type是否相等

check的模板参数为U, 其实就是输入判定的类型参数为int, 返回类型为decltype(std::declval&lt;U>().member(std::declval&lt;Args>()...), std::true_type())
member会被before或after替代

decltype(std::declval&lt;U>().member(std::declval&lt;Args>()...), std::true_type())输入两个参数, 当std::declval&lt;U>().member(std::declval&lt;Args>()...)有效时会输出std::true_type()

struct A &#123;              // abstract class
  virtual int value() = 0;
&#125;;
 
class B : public A &#123;    // class with specific constructor
  int val_;
public:
  B(int i,int j):val_(i*j)&#123;&#125;
  int value() &#123;return val_;&#125;
&#125;;
 
int main() &#123;
  decltype(std::declval&lt;A>().value()) a;  // int a
  decltype(std::declval&lt;B>().value()) b;  // int b
  decltype(B(0,0).value()) c;   // same as above (known constructor)
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HAS_MEMBER</span><span class="token expression"><span class="token punctuation">(</span>member<span class="token punctuation">)</span>                                                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">></span>                                                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">HasMember_</span></span><span class="token punctuation">##</span><span class="token expression">member                                                                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#123;</span>                                                                                                            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">private</span><span class="token operator">:</span>                                                                                                     </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token operator">></span>                                                                                 </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">auto</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>U<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">member</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">true_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
                                                                                                                 <span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token operator">></span>                                                                                    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>false_type <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                       </span><span class="token punctuation">\</span>
                                                                                                                 <span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                                                                      </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">enum</span>                                                                                                     </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">&#123;</span>                                                                                                        </span><span class="token punctuation">\</span>
            <span class="token expression">value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">check</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>true_type<span class="token operator">></span><span class="token double-colon punctuation">::</span>value                                   </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                                                                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">namespace</span> WzAop
<span class="token punctuation">&#123;</span>
<span class="token comment">/// 这里是判断切片类是否有要执行的成员函数, 例如before等。基本思路是使用std::declval&lt;U>()</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HAS_MEMBER</span><span class="token expression"><span class="token punctuation">(</span>member<span class="token punctuation">)</span>                                                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">></span>                                                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">HasMember_</span></span><span class="token punctuation">##</span><span class="token expression">member                                                                                    </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#123;</span>                                                                                                            </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">private</span><span class="token operator">:</span>                                                                                                     </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token operator">></span>                                                                                    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">auto</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">decltype</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>U<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">member</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">declval</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">true_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
                                                                                                                 <span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token operator">></span>                                                                                    </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>false_type <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                       </span><span class="token punctuation">\</span>
                                                                                                                 <span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">public</span><span class="token operator">:</span>                                                                                                      </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">enum</span>                                                                                                     </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">&#123;</span>                                                                                                        </span><span class="token punctuation">\</span>
            <span class="token expression">value <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>is_same<span class="token operator">&lt;</span><span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">check</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>true_type<span class="token operator">></span><span class="token double-colon punctuation">::</span>value                                   </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                                                                                                       </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></span></span>

    <span class="token comment">/// 宏定义将解折叠, 形成HasMember_before和HasMember_after</span>
    <span class="token function">HAS_MEMBER</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span>
    <span class="token function">HAS_MEMBER</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Function</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">></span>
    <span class="token keyword">class</span> <span class="token class-name">CppAop</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CppAop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

        <span class="token comment">/// 拷贝函数被delete</span>
        <span class="token function">CppAop</span><span class="token punctuation">(</span><span class="token keyword">const</span> CppAop <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
        CppAop <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> CppAop <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        <span class="token comment">/// 用Function赋值给m_func</span>
        <span class="token function">CppAop</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;&amp;</span>f<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">m_func</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Function<span class="token operator">></span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/// std::enable_if 满足条件时类型有效。</span>
        <span class="token comment">/// 只有HasMember_before&lt;T, Args...>::value &amp;&amp; HasMember_after&lt;T, Args...>::value都为true有效, 显然基于宏定义</span>
        <span class="token comment">/// value = std::is_same&lt;decltype(check&lt;T>(0)), std::true_type>::value, value是bool型</span>
        <span class="token comment">/// type std::enable_if&lt;>::type, </span>
        <span class="token comment">/// type	either T or no such member, depending on the value of B</span>
        <span class="token comment">/*
        template&lt;bool B, class T = void>
        struct enable_if &#123;&#125;;

        template&lt;class T>
        struct enable_if&lt;true, T> &#123; typedef T type; &#125;;
        */</span>  
       <span class="token comment">/// invoke接受切片类并执行之(aspect.before) </span>
       <span class="token comment">/// m_func是已经提前赋值的执行函数</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
        <span class="token keyword">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>enable_if<span class="token operator">&lt;</span>HasMember_before<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value <span class="token operator">&amp;&amp;</span> HasMember_after<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token operator">></span><span class="token double-colon punctuation">::</span>type
        <span class="token function">invoke</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">,</span> T <span class="token operator">&amp;&amp;</span>aspect<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            aspect<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">m_func</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aspect<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">/// aspect是输入的切片类对象, 类型是T的通用引用</span>
        <span class="token comment">/// Args &amp;&amp;... args 是可被before, m_func等函数执行的参数</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
        <span class="token keyword">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>enable_if<span class="token operator">&lt;</span>HasMember_before<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>HasMember_after<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token operator">></span><span class="token double-colon punctuation">::</span>type
        <span class="token function">invoke</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">,</span> T <span class="token operator">&amp;&amp;</span>aspect<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            aspect<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">m_func</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
        <span class="token keyword">typename</span> <span class="token class-name">std</span><span class="token double-colon punctuation">::</span>enable_if<span class="token operator">&lt;</span><span class="token operator">!</span>HasMember_before<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value <span class="token operator">&amp;&amp;</span> HasMember_after<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span><span class="token double-colon punctuation">::</span>value<span class="token operator">></span><span class="token double-colon punctuation">::</span>type
        <span class="token function">invoke</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">,</span> T <span class="token operator">&amp;&amp;</span>aspect<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">m_func</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aspect<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">Head</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Tail<span class="token operator">></span>
        <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">,</span> Head <span class="token operator">&amp;&amp;</span>headAspect<span class="token punctuation">,</span> Tail <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> tailAspect<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            headAspect<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">invoke</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Tail<span class="token operator">></span></span></span><span class="token punctuation">(</span>tailAspect<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            headAspect<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        Function m_func<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token comment">/* Cross platform deal: compatibility for visual studio &amp; g++ */</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span>
    <span class="token keyword">using</span> identity_t <span class="token operator">=</span> T<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span> <span class="token comment">/* namespace WzAop */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>

<p>GenAop.hpp</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__GENERALAOP_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__GENERALAOP_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CppAop.hpp"</span></span>

<span class="token keyword">class</span> <span class="token class-name">GeneralAop</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">GeneralAop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">GeneralAop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

<span class="token comment">/// 模板参数类型为一个Function, 一些args.而且很显然AP表示AOP整合的通用类, 比如日志类</span>
<span class="token comment">/// 参数Function是要执行的函数, 后面Args是参数</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> AP<span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">Function</span><span class="token operator">></span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>Function <span class="token operator">&amp;&amp;</span>f<span class="token punctuation">,</span> Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">/// 基于要执行的function args生成WzAop对象</span>
        <span class="token comment">/// 向CppAop注册要执行的function</span>
        WzAop<span class="token double-colon punctuation">::</span>CppAop<span class="token operator">&lt;</span>Function<span class="token punctuation">,</span> Args<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">></span> <span class="token function">asp</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Function<span class="token operator">></span></span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// 向CppAop注册切片类AP, asp是构建好的要执行的function, 基于切片类AP调用invoke</span>
        <span class="token comment">/// WzAop::identity_t 返回AP的类型</span>
        asp<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">></span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> WzAop<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">identity_t</span><span class="token generic class-name"><span class="token operator">&lt;</span>AP<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>

<p>aop.cc</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"GenAop.hpp"</span></span>

<span class="token keyword">void</span> <span class="token function">aopTest1</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test1...%d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">AopTest2</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> data1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string data2<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test2...%d,%s\n"</span><span class="token punctuation">,</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/// 切片类, Log</span>
<span class="token keyword">class</span> <span class="token class-name">Log</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"log before...%d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"log after...%d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">int</span> data1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string data2<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"log before...%d,%s\n"</span><span class="token punctuation">,</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">int</span> data1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string data2<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"log after...%d,%s\n"</span><span class="token punctuation">,</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/// 切片类Security</span>
<span class="token keyword">class</span> <span class="token class-name">Security</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"security before...%d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">int</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"security after...%d\n"</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">int</span> data1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string data2<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"security before...%d,%s\n"</span><span class="token punctuation">,</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">int</span> data1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>string data2<span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"security after...%d,%s\n"</span><span class="token punctuation">,</span>data1<span class="token punctuation">,</span>data2<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">/* test1 */</span>
    <span class="token comment">// 调用GeneralAop, Log,Security为AOP部分</span>
	GeneralAop<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">invoke</span><span class="token generic class-name"><span class="token operator">&lt;</span>Log<span class="token punctuation">,</span>Security<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aopTest1<span class="token punctuation">,</span> <span class="token number">123456</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* test2 */</span>
	AopTest2 test2<span class="token punctuation">;</span>
	GeneralAop<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">invoke</span><span class="token generic class-name"><span class="token operator">&lt;</span>Log<span class="token punctuation">,</span>Security<span class="token operator">></span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AopTest2<span class="token double-colon punctuation">::</span>test<span class="token punctuation">,</span><span class="token operator">&amp;</span>test2<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">654321</span><span class="token punctuation">,</span><span class="token string">"blablabla"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/cpp%E8%BF%9B%E9%98%B6/2021-10-08-%E6%B5%85%E8%B0%88C++%E8%BF%9E%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="prev" title="浅谈C/C++ mysql-client"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">浅谈C/C++ mysql-client</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/%E7%AE%97%E6%B3%95/2021-09-27-%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%B1%87%E6%80%BB/" rel="next" title="排序算法汇总"><span class="post-nav-text">排序算法汇总</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何关于博客内容的相关讨论，欢迎前往 <a href="https://github.com/YunYouJun/yunyoujun.github.io/discussions" target="_blank">GitHub Discussions</a> 与我交流。</span><br></div><div id="valine-container"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js", () => {
  const valineConfig = {"enable":true,"appId":"K4LElSwpTJaHOOTTU6mNGCyr-gzGzoHsz","appKey":"x3d4Sv6rdTYOECKqkxg9r905","placeholder":"填写邮箱，可以收到回复通知哦～","avatar":null,"pageSize":10,"visitor":false,"highlight":true,"recordIP":false,"enableQQ":true,"meta":["nick","mail","link"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = "/cpp%E8%BF%9B%E9%98%B6/2021-10-08-%E6%B5%85%E8%B0%88%E5%AF%B9%E8%B1%A1%E6%8E%A7%E5%88%B6/"
  new Valine(valineConfig)
}, window.Valine);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">萌ICP备666666号</a></div><div class="copyright"><span>&copy; 2020 – 2021 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="https://sponsors.yunyoujun.cn" title="云游君的赞助者们"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></a><span class="author"> larry</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.6.3</span></div><div class="live_time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-04-12T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script defer src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script defer src="/js/search/algolia-search.js"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div class="algolia-pagination" id="algolia-pagination"></div></div></div></div><!-- hexo injector body_end start --><script src="/js/tag-common/index.js"></script><!-- hexo injector body_end end --></body></html>